# 回测问题诊断与修复报告

## 📋 问题总结

### 1. ⚠️ 警告信息（非致命问题）

**现象**：
- 多次出现 `$open: 0.0!!!` 警告
- `divide by zero` 警告

**原因**：
- 数据中存在开盘价为0的记录（约1400条，占比0.47%）
- 这些记录通常对应停牌、退市或数据缺失的情况
- 配置中使用 `deal_price: "open"`，但开盘价为0时qlib会自动使用收盘价

**影响**：
- 可能导致回测结果不准确
- 但不会导致回测失败

**状态**：✅ **已修复** - 已将配置改为使用收盘价成交

---

### 2. ⚠️ 年化收益异常高

**现象**：
- 年化收益: **42.25%**
- 信息比率: 0.66
- 最大回撤: -50.35%

**分析**：
- 42.25%的年化收益意味着4年（2022-2025）总收益约为 **309.4%**
- 这在A股市场通常是不现实的
- 可能的原因：
  1. **数据质量问题**：开盘价为0导致交易价格异常
  2. **回测逻辑问题**：年化收益计算可能有误
  3. **数据泄露**：可能存在未来数据泄露
  4. **样本偏差**：某些异常股票影响整体结果

**状态**：⚠️ **待验证** - 已修复成交价格配置，需要重新运行回测验证

---

### 3. ✅ 数据情况检查

#### 股票池
- **状态**：✅ 正常
- **数量**：292只股票（csi300）
- **获取方式**：正确使用 `D.instruments()` 和 `D.list_instruments()`

#### 数据日期范围
- **状态**：✅ 完整
- **范围**：2022-01-04 到 2025-12-31
- **交易日数**：969天
- **各年分布**：
  - 2022年: 242天
  - 2023年: 242天
  - 2024年: 242天
  - 2025年: 243天

#### 数据质量问题
- **开盘价为0**：1400条记录（占比0.47%）
- **影响股票**：主要是停牌、退市股票
- **最严重**：SH600253 有726条异常记录

---

### 4. ✅ 回测框架确认

**使用框架**：Qlib
- ✅ 使用 `qlib.backtest.backtest` 进行回测
- ✅ 使用 `SimulatorExecutor` 作为执行器
- ✅ 使用 `TopkDropoutStrategy` 作为策略
- ✅ 数据来源：`/home/tjxy/.qlib/qlib_data/cn_data`
- ✅ **数据格式**：Qlib内部格式（**不是h5文件**）

**说明**：
- Qlib不使用h5文件存储数据
- 数据存储在 `/home/tjxy/.qlib/qlib_data/cn_data` 目录中
- 使用Qlib自己的数据格式和索引系统

---

## 🔧 已实施的修复

### 1. 修改成交价格配置

**文件**：`backtest_v2/config.yaml`

**修改前**：
```yaml
deal_price: "open"
```

**修改后**：
```yaml
deal_price: "close"  # 改为收盘价成交，避免开盘价为0的问题
```

**原因**：
- 避免开盘价为0导致的交易异常
- 收盘价数据更稳定可靠

---

### 2. 添加股票池大小检查

**文件**：`backtest_v2/backtest_runner.py`

**添加**：
```python
if len(stock_list) < 10:
    logger.warning(f"⚠️  警告: 股票池过小 ({len(stock_list)} 只股票)，回测结果可能不可信！")
```

---

## 📊 数据质量详情

### 开盘价为0的记录统计

| 股票代码 | 异常记录数 | 说明 |
|---------|-----------|------|
| SH600253 | 726 | 可能长期停牌或退市 |
| SH600190 | 59 | 停牌期间 |
| SH600289 | 51 | 停牌期间 |
| SH600090 | 40 | 停牌期间 |
| ... | ... | ... |

**总计**：1400条记录，占比约0.47%

---

## 🎯 下一步行动

### 1. 重新运行回测

使用修复后的配置重新运行回测：

```bash
cd /home/tjxy/quantagent/AlphaAgent
python backtest_v2/run_backtest.py -c backtest_v2/config.yaml --factor-source alpha158_20
```

### 2. 验证结果

检查新的回测结果：
- 年化收益是否在合理范围内（通常5-15%）
- 是否还有开盘价为0的警告
- 信息比率是否稳定

### 3. 如果问题仍然存在

如果年化收益仍然异常高，需要检查：
1. **数据泄露**：确认没有使用未来数据
2. **回测逻辑**：检查年化收益计算是否正确
3. **数据质量**：考虑过滤掉异常股票或交易日

---

## 📝 配置说明

### 当前回测配置

```yaml
backtest:
  backtest:
    start_time: "2022-01-01"
    end_time: "2025-12-26"
    account: 100000000
    benchmark: "SH000905"
    exchange_kwargs:
      limit_threshold: 0.095
      deal_price: "close"  # ✅ 已修复
      open_cost: 0.0005
      close_cost: 0.0015
      min_cost: 5
```

### 数据集划分

```yaml
segments:
  train: ["2016-01-01", "2020-12-31"]
  valid: ["2021-01-01", "2021-12-31"]
  test:  ["2022-01-01", "2025-12-26"]
```

**注意**：
- 训练集：2016-2020（5年）
- 验证集：2021（1年）
- 测试集：2022-2025（4年）
- 回测期间：2022-2025（与测试集一致）

---

## ✅ 确认事项

- [x] 股票池正常（292只股票）
- [x] 数据日期范围完整（2022-2025年，969个交易日）
- [x] 使用Qlib框架回测（无h5文件）
- [x] 已修复成交价格配置（改为收盘价）
- [ ] 需要重新运行回测验证结果
- [ ] 如果年化收益仍然异常，需要进一步调查

---

## 📌 重要提示

1. **年化收益42.25%异常高**，需要重新验证
2. **开盘价为0的问题**已通过改用收盘价成交解决
3. **数据完整性正常**，覆盖2022-2025年全年
4. **使用Qlib框架**，数据存储在Qlib内部格式中（非h5文件）

---

**报告生成时间**：2026-01-12
**诊断脚本**：`backtest_v2/diagnose_backtest.py`
**数据质量报告**：`backtest_v2/data_quality_report.md`

